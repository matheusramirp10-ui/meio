<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-app.js";
  import { getFirestore, collection, getDocs, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-firestore.js";

  // Configuração do Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyD04B5H_7chnjwiiFgk-f_tKh7MZFJaho0",
    authDomain: "analivia-cb075.firebaseapp.com",
    projectId: "analivia-cb075",
    storageBucket: "analivia-cb075.appspot.com",
    messagingSenderId: "979185575456",
    appId: "1:979185575456:web:5f65bf9ea75b4a7b3c3e45"
  };

  // Inicializa Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // --- Seus produtos iniciais locais ---
  let products = [
    { name: "Vestido Vermelho Elegante", price: "179,90", image: "vestido1.jpg", category:"Vestidos Femininos" },
    { name: "Vestido Floral Rosa", price: "189,90", image: "vestido2.jpg", category:"Vestidos Femininos" },
    { name: "Vestido Verde Poá", price: "169,90", image: "vestido3.jpg", category:"Vestidos Femininos" }
  ];

  // --- Função para renderizar produtos (sua existente) ---
  function render(productsToShow){
    const grid = document.getElementById('productsGrid');
    grid.innerHTML = "";
    productsToShow.forEach(p => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <img src="${p.image}" alt="${p.name}" onerror="this.src='https://via.placeholder.com/400x400.png?text=Imagem+Indisponível'"/>
        <div class="body">
          <strong>${p.name}</strong>
          <span class="muted">${p.category}</span>
          <span class="price">R$ ${p.price}</span>
          <button class="buy" onclick="comprar('${p.name}')">Comprar</button>
        </div>
      `;
      grid.appendChild(card);
    });
  }

  render(products);

  // --- Comprar via WhatsApp ---
  function comprar(nome){
    window.open('https://wa.me/5577981518721?text=' + encodeURIComponent("Olá, vim pelo site e quero fazer um pedido: " + nome), '_blank');
  }

  // --- Admin ---
  const PASS = "15390640";
  const btnLogin = document.getElementById('btnLogin');
  btnLogin.addEventListener('click', () => {
    const v = document.getElementById('adminPass').value;
    if(v === PASS){
      document.getElementById('loginPanel').style.display = "none";
      document.getElementById('editorPanel').style.display = "";
      document.getElementById('jsonArea').value = JSON.stringify(products, null, 2);
    }else{
      alert("Senha incorreta!");
    }
  });

  // --- Aplicar alterações no Firebase ---
  document.getElementById('btnAplicar').addEventListener('click', async ()=>{
    try{
      const parsed = JSON.parse(document.getElementById('jsonArea').value);
      if(!Array.isArray(parsed)) throw new Error("O JSON deve ser um array.");
      products = parsed;
      render(products);

      // Enviar produtos para Firebase
      for(const [idx, p] of products.entries()){
        await setDoc(doc(db, "products", "product" + idx), p); 
        // Cada produto recebe um ID: product0, product1...
      }

      alert("Alterações aplicadas e salvas no Firebase.");
    }catch(err){
      alert("Erro no JSON ou Firebase: " + err.message);
    }
  });

  // --- Baixar JSON (mantido) ---
  document.getElementById('btnBaixar').addEventListener('click', ()=>{
    const blob = new Blob([document.getElementById('jsonArea').value], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "products.json";
    a.click();
    URL.revokeObjectURL(url);
  });
</script>
